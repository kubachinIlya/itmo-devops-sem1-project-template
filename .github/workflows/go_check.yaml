name: Go Test Pipeline

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6

      - name: Set up Go
        uses: actions/setup-go@v4
        with:
          go-version: "1.23"

      - name: Make scripts executable
        run: chmod +x scripts/*.sh

      - name: Prepare environment
        run: ./scripts/prepare.sh

      - name: Install yc
        uses: lxhan/yc-install@v3

      - name: Run application in Yandex Cloud
        id: deploy
        run: ./scripts/run.sh
        env:
          YC_SA_KEY: ${{ secrets.YC_SA_KEY }}
          YC_FOLDER_ID: ${{ secrets.YC_FOLDER_ID }}
          YC_SUBNET_ID: ${{ secrets.YC_SUBNET_ID }}
          YC_SSH_PRIVATE_KEY: ${{ secrets.YC_SSH_PRIVATE_KEY }}
          YC_SSH_PUBLIC_KEY: ${{ secrets.YC_SSH_PUBLIC_KEY }}

      - name: Set environment variables from deployment
        run: |
          if [ -f vm_ip.txt ]; then
            IP=$(cat vm_ip.txt)
            echo "API_HOST=http://$IP:8080" >> $GITHUB_ENV
            echo "DB_HOST=$IP" >> $GITHUB_ENV
            echo "VM_IP=$IP" >> $GITHUB_ENV
            echo "✅ API_HOST=http://$IP:8080"
            echo "✅ DB_HOST=$IP"
          fi

      - name: Test Level 1
        id: test-level-1
        continue-on-error: true
        run: ./scripts/tests.sh 1
        env:
          API_HOST: ${{ env.API_HOST }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: 5432
          DB_NAME: project-sem-1
          DB_USER: validator
          DB_PASSWORD: val1dat0r

      - name: Test Level 2
        id: test-level-2
        continue-on-error: true
        run: ./scripts/tests.sh 2
        env:
          API_HOST: ${{ env.API_HOST }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: 5432
          DB_NAME: project-sem-1
          DB_USER: validator
          DB_PASSWORD: val1dat0r

      - name: Test Level 3
        id: test-level-3
        continue-on-error: true
        run: ./scripts/tests.sh 3
        env:
          API_HOST: ${{ env.API_HOST }}
          DB_HOST: ${{ env.DB_HOST }}
          DB_PORT: 5432
          DB_NAME: project-sem-1
          DB_USER: validator
          DB_PASSWORD: val1dat0r

      - name: Check test results
        if: always()
        run: |
          if [[ "${{ steps.test-level-1.outcome }}" == "success" ]] || \
             [[ "${{ steps.test-level-2.outcome }}" == "success" ]] || \
             [[ "${{ steps.test-level-3.outcome }}" == "success" ]]; then
            echo "At least one test level passed successfully!"
            exit 0
          else
            echo "All test levels failed!"
            exit 1
          fi